name: Deploy Axon

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - 'GITHUB_PAGES.md'
      - 'server.js'
      - 'database/**'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.
          
          echo "üöÄ Starting deployment..."
          
          # Use a temporary directory for the clone
          CLONE_DIR=$(mktemp -d)
          
          # Clone the repository
          git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "$CLONE_DIR"
          cd "$CLONE_DIR"
          
          echo "üìÅ Repository cloned successfully"
          
          # Create a temporary directory for the site content
          SITE_DIR=$(mktemp -d)
          
          # Copy static files to the site directory
          echo "üìã Copying files..."
          cp index.html "$SITE_DIR/"
          # Check if 'public' directory exists before copying
          if [ -d "public" ]; then
            cp -r public "$SITE_DIR/"
          else
            echo "‚ÑπÔ∏è No 'public' directory found, skipping."
          fi
          
          # Switch to or create the gh-pages branch
          echo "üåø Setting up gh-pages branch..."
          git checkout --orphan gh-pages-temp
          
          # Clear the temporary branch
          echo "üßπ Clearing old content..."
          git rm -rf .
          
          # Copy new content from the site directory
          echo "üì¶ Deploying new content..."
          cp -r "$SITE_DIR"/* .
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Add all files
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to deploy"
          else
            # Commit and push
            git commit -m "üöÄ Deploy from main branch - $(date)"
            echo "üì§ Pushing to gh-pages..."
            # Force push to the actual gh-pages branch
            git push --force "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:gh-pages
            echo "‚úÖ Deployment completed successfully!"
          fi
          
          echo "üåê Site will be available at: https://${{ github.repository_owner }}.github.io/axon/"
