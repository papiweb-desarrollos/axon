name: Deploy Axon

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - 'GITHUB_PAGES.md'
      - 'server.js'
      - 'database/**'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # Clone the repository
          git clone https://github.com/${{ github.repository }}.git repo
          cd repo
          
          echo "ğŸ“ Repository cloned successfully"
          
          # Create deployment directory
          mkdir -p ../site
          
          # Copy static files
          echo "ğŸ“‹ Copying files..."
          cp index.html ../site/
          [ -d public ] && cp -r public ../site/ || echo "â„¹ï¸ No public directory found"
          [ -f _config.yml ] && cp _config.yml ../site/ || echo "â„¹ï¸ No Jekyll config found"
          
          # Create or switch to gh-pages branch
          echo "ğŸŒ¿ Setting up gh-pages branch..."
          git fetch origin gh-pages 2>/dev/null || echo "â„¹ï¸ gh-pages branch doesn't exist yet"
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
          
          # Clear existing content
          echo "ğŸ§¹ Clearing old content..."
          rm -rf * .*
          
          # Copy new content
          echo "ğŸ“¦ Deploying new content..."
          cp -r ../site/* .
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Add all files
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "âœ… No changes to deploy"
          else
            # Commit and push
            git commit -m "ğŸš€ Deploy from main branch - $(date)"
            echo "ğŸ“¤ Pushing to gh-pages..."
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages
            echo "âœ… Deployment completed successfully!"
          fi
          
          echo "ğŸŒ Site will be available at: https://${{ github.repository_owner }}.github.io/axon/"
